# 需求文档

## 简介

本系统是一个基于微信测试号的消息通知平台，使用 React 前端、Go 后端和 SQLite 数据库构建。系统支持 OIDC 登录认证，允许用户向预设的接收者发送自定义消息通知。

## 术语表

- **微信测试号 (WeChat_Test_Account)**: 微信公众平台测试号，用于发送模板消息
- **通知系统 (Notification_System)**: 本消息通知系统
- **接收者 (Recipient)**: 消息接收者，已关注测试号的微信用户
- **OIDC提供者 (OIDC_Provider)**: OpenID Connect 身份认证提供者
- **消息模板 (Message_Template)**: 微信模板消息格式

## 需求

### 需求 1

**用户故事:** 作为用户，我希望通过 OIDC 认证登录系统，以便安全地访问通知系统。

#### 验收标准

1. WHEN 用户未认证访问通知系统 THEN 通知系统 SHALL 重定向用户到 OIDC_Provider 登录页面
2. WHEN OIDC_Provider 返回有效的认证令牌 THEN 通知系统 SHALL 创建用户会话并重定向到主页
3. WHEN OIDC_Provider 返回认证错误 THEN 通知系统 SHALL 显示错误信息并允许重试
4. WHEN 用户点击登出按钮 THEN 通知系统 SHALL 终止会话并重定向到登录页面

### 需求 2

**用户故事:** 作为用户，我希望发送带有标题和内容的消息给选定的接收者，以便通过微信通知特定的人。

#### 验收标准

1. WHEN 用户提交包含标题、内容和选定接收者的消息 THEN 通知系统 SHALL 通过微信测试号向所有选定接收者发送消息
2. WHEN 用户尝试发送消息但未选择任何接收者 THEN 通知系统 SHALL 显示验证错误并阻止提交
3. WHEN 用户尝试发送标题或内容为空的消息 THEN 通知系统 SHALL 显示验证错误并阻止提交
4. WHEN 微信测试号 API 返回成功响应 THEN 通知系统 SHALL 向用户显示成功通知
5. WHEN 微信测试号 API 返回错误 THEN 通知系统 SHALL 显示错误详情并允许重试

### 需求 3

**用户故事:** 作为用户，我希望在设置页面管理消息接收者，以便添加或删除可以接收通知的人。

#### 验收标准

1. WHEN 用户导航到设置页面 THEN 通知系统 SHALL 显示所有已配置接收者的列表
2. WHEN 用户添加具有有效微信 OpenID 和名称的新接收者 THEN 通知系统 SHALL 将接收者保存到数据库
3. WHEN 用户尝试添加无效或重复 OpenID 的接收者 THEN 通知系统 SHALL 显示验证错误
4. WHEN 用户删除接收者 THEN 通知系统 SHALL 从数据库中移除该接收者
5. WHEN 用户编辑接收者名称 THEN 通知系统 SHALL 更新数据库中的接收者信息

### 需求 4

**用户故事:** 作为用户，我希望在发送消息时可以多选接收者，以便一次通知多个人。

#### 验收标准

1. WHEN 用户查看消息发送表单 THEN 通知系统 SHALL 将所有接收者显示为可选复选框
2. WHEN 用户选择多个接收者 THEN 通知系统 SHALL 将所有选定接收者包含在消息发送中
3. WHEN 用户点击"全选" THEN 通知系统 SHALL 选中所有可用接收者
4. WHEN 用户点击"取消全选" THEN 通知系统 SHALL 取消选中所有接收者

### 需求 5

**用户故事:** 作为系统管理员，我希望系统持久化存储接收者数据，以便接收者配置在系统重启后保留。

#### 验收标准

1. WHEN 添加接收者 THEN 通知系统 SHALL 将接收者数据持久化到 SQLite 数据库
2. WHEN 通知系统启动 THEN 通知系统 SHALL 从 SQLite 数据库加载所有接收者
3. WHEN 数据库操作失败 THEN 通知系统 SHALL 记录错误并显示用户友好的错误信息

### 需求 6

**用户故事:** 作为开发者，我希望系统集成微信测试号 API，以便消息可以发送给微信用户。

#### 验收标准

1. WHEN 通知系统发送消息 THEN 通知系统 SHALL 按照微信消息模板规范格式化消息
2. WHEN 访问令牌过期 THEN 通知系统 SHALL 在发送消息前自动刷新令牌
3. WHEN 序列化微信 API 的消息数据 THEN 通知系统 SHALL 将数据编码为 JSON 格式
4. WHEN 反序列化微信 API 响应 THEN 通知系统 SHALL 解析 JSON 响应并提取相关字段
5. WHEN 打印消息数据用于调试 THEN 通知系统 SHALL 将 JSON 数据格式化为可读字符串
