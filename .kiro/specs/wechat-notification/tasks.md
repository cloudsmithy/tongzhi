# 实现计划

- [-] 1. 初始化项目结构
  - [ ] 1.1 创建后端 Go 项目结构
    - 初始化 Go module，创建目录结构 (config, handlers, models, services, repository, middleware)
    - 添加依赖: gin, sqlite3, oidc
    - _需求: 5.1, 6.1_
  - [ ] 1.2 创建前端 React 项目
    - 使用 Vite 创建 React + TypeScript 项目
    - 添加依赖: react-router-dom, axios
    - 创建目录结构 (components, pages, services, types)
    - _需求: 2.1, 3.1, 4.1_

- [x] 2. 实现数据模型和数据库层
  - [x] 2.1 定义数据模型
    - 创建 Recipient, SendMessageRequest, WeChatTemplateMessage, WeChatAPIResponse 结构体
    - _需求: 3.2, 6.1_
  - [x] 2.2 实现 SQLite 数据库初始化和接收者仓库
    - 创建数据库连接和表初始化
    - 实现 CRUD 操作: Create, GetAll, GetByID, Update, Delete
    - 实现 OpenID 唯一性检查
    - _需求: 3.2, 3.4, 3.5, 5.1, 5.2_
  - [x] 2.3 编写属性测试: 接收者添加持久化
    - **属性 7: 接收者添加持久化**
    - **验证: 需求 3.2, 5.1**
  - [x] 2.4 编写属性测试: 重复 OpenID 拒绝
    - **属性 8: 重复 OpenID 拒绝**
    - **验证: 需求 3.3**
  - [x] 2.5 编写属性测试: 接收者删除
    - **属性 9: 接收者删除**
    - **验证: 需求 3.4**
  - [x] 2.6 编写属性测试: 接收者更新
    - **属性 10: 接收者更新**
    - **验证: 需求 3.5**
  - [x] 2.7 编写属性测试: 数据持久化往返
    - **属性 12: 数据持久化往返**
    - **验证: 需求 5.2**

- [x] 3. 实现消息验证逻辑
  - [x] 3.1 实现消息验证函数
    - 验证标题和内容非空（包括纯空白字符检测）
    - 验证接收者列表非空
    - _需求: 2.2, 2.3_
  - [x] 3.2 编写属性测试: 空接收者列表验证
    - **属性 4: 空接收者列表验证**
    - **验证: 需求 2.2**
  - [x] 3.3 编写属性测试: 空白消息验证
    - **属性 5: 空白消息验证**
    - **验证: 需求 2.3**

- [x] 4. 实现微信 API 集成
  - [x] 4.1 实现令牌管理器
    - 获取和缓存 access_token
    - 实现令牌过期检测和自动刷新
    - _需求: 6.2_
  - [x] 4.2 实现微信消息服务
    - 格式化消息为微信模板格式
    - 发送模板消息到指定 OpenID
    - 解析 API 响应
    - _需求: 6.1, 6.3, 6.4_
  - [x] 4.3 编写属性测试: 微信消息格式化
    - **属性 13: 微信消息格式化**
    - **验证: 需求 6.1**
  - [x] 4.4 编写属性测试: JSON 序列化往返
    - **属性 14: JSON 序列化往返**
    - **验证: 需求 6.3, 6.4**
  - [x] 4.5 编写属性测试: 令牌自动刷新
    - **属性 15: 令牌自动刷新**
    - **验证: 需求 6.2**

- [x] 5. 检查点 - 确保所有测试通过
  - 确保所有测试通过，如有问题请询问用户。

- [x] 6. 实现后端 API 处理器
  - [x] 6.1 实现接收者处理器
    - GET /api/recipients - 获取所有接收者
    - POST /api/recipients - 添加接收者
    - PUT /api/recipients/:id - 更新接收者
    - DELETE /api/recipients/:id - 删除接收者
    - _需求: 3.1, 3.2, 3.4, 3.5_
  - [x] 6.2 实现消息处理器
    - POST /api/messages/send - 发送消息给选定接收者
    - 调用验证逻辑和微信服务
    - _需求: 2.1, 2.4, 2.5_
  - [x] 6.3 编写属性测试: 接收者列表完整性
    - **属性 6: 接收者列表完整性**
    - **验证: 需求 3.1**
  - [x] 6.4 编写属性测试: 消息发送到所有选定接收者
    - **属性 3: 消息发送到所有选定接收者**
    - **验证: 需求 2.1, 4.2**

- [x] 7. 实现 OIDC 认证
  - [x] 7.1 实现认证处理器
    - GET /auth/login - 重定向到 OIDC 提供者
    - GET /auth/callback - 处理 OIDC 回调，创建会话
    - POST /auth/logout - 终止会话
    - _需求: 1.1, 1.2, 1.4_
  - [x] 7.2 实现认证中间件
    - 验证请求中的会话令牌
    - 未认证请求返回 401 或重定向
    - _需求: 1.1, 1.3_
  - [x] 7.3 编写属性测试: 未认证访问重定向
    - **属性 1: 未认证访问重定向**
    - **验证: 需求 1.1**
  - [x] 7.4 编写属性测试: 登出终止会话
    - **属性 2: 登出终止会话**
    - **验证: 需求 1.4**

- [x] 8. 实现前端类型和 API 服务
  - [x] 8.1 定义 TypeScript 类型
    - Recipient, SendMessageRequest, ApiResponse 等类型
    - _需求: 2.1, 3.1_
  - [x] 8.2 实现 API 客户端
    - 封装 axios 请求
    - 实现接收者 API 和消息 API 调用
    - 处理认证状态
    - _需求: 2.1, 3.1_

- [x] 9. 实现前端页面
  - [x] 9.1 实现布局组件和路由
    - 创建导航栏（主页、设置、登出）
    - 配置 React Router
    - _需求: 1.4, 3.1_
  - [x] 9.2 实现登录页面
    - 显示登录按钮，点击跳转到 OIDC 登录
    - 处理认证错误显示
    - _需求: 1.1, 1.3_
  - [x] 9.3 实现主页（消息发送）
    - 消息表单：标题、内容输入框
    - 接收者多选复选框列表
    - 全选/取消全选按钮
    - 发送按钮和结果反馈
    - _需求: 2.1, 2.2, 2.3, 2.4, 2.5, 4.1, 4.2, 4.3, 4.4_
  - [x] 9.4 编写属性测试: 全选/取消全选
    - **属性 11: 全选/取消全选**
    - **验证: 需求 4.3, 4.4**
  - [x] 9.5 实现设置页面（接收者管理）
    - 接收者列表显示
    - 添加接收者表单（OpenID、名称）
    - 编辑和删除功能
    - _需求: 3.1, 3.2, 3.3, 3.4, 3.5_

- [x] 10. 集成和配置
  - [x] 10.1 创建配置文件
    - 后端配置: OIDC 设置、微信 API 凭证、数据库路径
    - 前端配置: API 基础 URL
    - _需求: 1.1, 6.1_
  - [x] 10.2 整合前后端
    - 配置 CORS
    - 设置代理或静态文件服务
    - _需求: 2.1_

- [x] 11. 最终检查点 - 确保所有测试通过
  - 确保所有测试通过，如有问题请询问用户。
